"use strict";(self.webpackChunkhasura_extra_github_io=self.webpackChunkhasura_extra_github_io||[]).push([[719],{3905:function(e,n,t){t.d(n,{Zo:function(){return p},kt:function(){return m}});var a=t(7294);function r(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function i(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);n&&(a=a.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,a)}return t}function s(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?i(Object(t),!0).forEach((function(n){r(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):i(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function o(e,n){if(null==e)return{};var t,a,r=function(e,n){if(null==e)return{};var t,a,r={},i=Object.keys(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||(r[t]=e[t]);return r}(e,n);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(a=0;a<i.length;a++)t=i[a],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(r[t]=e[t])}return r}var l=a.createContext({}),c=function(e){var n=a.useContext(l),t=n;return e&&(t="function"==typeof e?e(n):s(s({},n),e)),t},p=function(e){var n=c(e.components);return a.createElement(l.Provider,{value:n},e.children)},u={inlineCode:"code",wrapper:function(e){var n=e.children;return a.createElement(a.Fragment,{},n)}},h=a.forwardRef((function(e,n){var t=e.components,r=e.mdxType,i=e.originalType,l=e.parentName,p=o(e,["components","mdxType","originalType","parentName"]),h=c(t),m=r,d=h["".concat(l,".").concat(m)]||h[m]||u[m]||i;return t?a.createElement(d,s(s({ref:n},p),{},{components:t})):a.createElement(d,s({ref:n},p))}));function m(e,n){var t=arguments,r=n&&n.mdxType;if("string"==typeof e||r){var i=t.length,s=new Array(i);s[0]=h;var o={};for(var l in n)hasOwnProperty.call(n,l)&&(o[l]=n[l]);o.originalType=e,o.mdxType="string"==typeof e?e:r,s[1]=o;for(var c=2;c<i;c++)s[c]=t[c];return a.createElement.apply(null,s)}return a.createElement.apply(null,t)}h.displayName="MDXCreateElement"},2181:function(e,n,t){t.r(n),t.d(n,{frontMatter:function(){return o},contentTitle:function(){return l},metadata:function(){return c},toc:function(){return p},default:function(){return h}});var a=t(7462),r=t(3366),i=(t(7294),t(3905)),s=["components"],o={id:"handle-table-event",title:"Handle table event",sidebar_title:"Handle table event"},l=void 0,c={unversionedId:"handle-event/handle-table-event",id:"handle-event/handle-table-event",isDocsHomePage:!1,title:"Handle table event",description:"Hasura Extra s\u1ebd dispatch table events triggered b\u1edfi Hasura",source:"@site/i18n/vi/docusaurus-plugin-content-docs/current/04-handle-event/01-handle-table-event.md",sourceDirName:"04-handle-event",slug:"/handle-event/handle-table-event",permalink:"/vi/handle-event/handle-table-event",editUrl:"https://github.com/hasura-extra/hasura-extra/edit/main/docusaurus/i18n/vi/docusaurus-plugin-content-docs/current/04-handle-event/01-handle-table-event.md",tags:[],version:"current",lastUpdatedBy:"Minh Vuong",lastUpdatedAt:1638075172,formattedLastUpdatedAt:"28/11/2021",sidebarPosition:1,frontMatter:{id:"handle-table-event",title:"Handle table event",sidebar_title:"Handle table event"},sidebar:"main",previous:{title:"GraphQLite",permalink:"/vi/handle-business-logic/graphqlite"},next:{title:"Config webhook",permalink:"/vi/authentication/config-webhook"}},p=[{value:"Th\xeam event trigger t\u1ea1i Hasura",id:"add-event-trigger",children:[],level:2},{value:"D\xe0nh cho Symfony users",id:"d\xe0nh-cho-symfony-users",children:[{value:"Security config",id:"security-config",children:[],level:3}],level:2}],u={toc:p};function h(e){var n=e.components,o=(0,r.Z)(e,s);return(0,i.kt)("wrapper",(0,a.Z)({},u,o,{components:n,mdxType:"MDXLayout"}),(0,i.kt)("p",null,"Hasura Extra s\u1ebd dispatch ",(0,i.kt)("a",{parentName:"p",href:"https://hasura.io/docs/latest/graphql/core/event-triggers/index.html"},"table events triggered")," b\u1edfi Hasura\nth\xf4ng qua ",(0,i.kt)("a",{parentName:"p",href:"https://www.php-fig.org/psr/psr-14/"},"PSR-14")," event dispatcher."),(0,i.kt)("p",null,"M\u1eb7c \u0111\u1ecbnh khi c\xe0i Symfony bundle url path \u0111\u1ec3 handle table event s\u1ebd l\xe0 ",(0,i.kt)("inlineCode",{parentName:"p"},"/hasura_table_event")," b\u1ea1n s\u1ebd c\u1ea7n url path n\xe0y \u1edf b\u01b0\u1edbc ",(0,i.kt)("a",{parentName:"p",href:"#add-event-trigger"},"th\xeam event trigger"),"."),(0,i.kt)("h2",{id:"add-event-trigger"},"Th\xeam event trigger t\u1ea1i Hasura"),(0,i.kt)("p",null,"\u0110\u1ea7u ti\xean b\u1ea1n c\u1ea7n th\xeam event trigger tr\xean Hasura xem h\u01b0\u1edbng d\u1eabn t\u1ea1i ",(0,i.kt)("a",{parentName:"p",href:"https://hasura.io/docs/latest/graphql/core/event-triggers/create-trigger.html"},"\u0111\xe2y"),"."),(0,i.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"N\u1ebfu nh\u01b0 b\u1ea1n s\u1eed d\u1ee5ng ",(0,i.kt)("a",{parentName:"p",href:"/vi/installation/symfony-app"},"Symfony App")," th\xec h\xe3y s\u1eed d\u1ee5ng value ",(0,i.kt)("inlineCode",{parentName:"p"},"{{APP_BASE_URI}}/hasura_table_event")," l\xe0m\nwebhook url m\u1ed7i khi th\xeam event trigger."))),(0,i.kt)("h2",{id:"d\xe0nh-cho-symfony-users"},"D\xe0nh cho Symfony users"),(0,i.kt)("p",null,(0,i.kt)("a",{parentName:"p",href:"https://symfony.com/doc/current/event_dispatcher.html"},"Event Dispatcher")," c\u1ee7a Symfony c\u0169ng implements ",(0,i.kt)("strong",{parentName:"p"},"PSR-14")," n\xean vi\u1ec7c handle event c\u1ee7a Hasura s\u1ebd kh\xf4ng kh\xe1c g\xec v\u1edbi c\xe1c system event m\xe0 b\u1ea1n hay handle\n(v\xed d\u1ee5 ",(0,i.kt)("inlineCode",{parentName:"p"},"kernel.request"),"). M\u1ed7i khi Hasura trigger table event, dispatcher s\u1ebd dispatch event ",(0,i.kt)("inlineCode",{parentName:"p"},"Hasura\\EventDispatcher\\TableEvent"),", b\u1ea1n\nch\u1ec9 c\u1ea7n subscribe/listen s\u1ef1 ki\u1ec7n tr\xean \u0111\u1ec3 ch\xe8n business logic, v\xed d\u1ee5:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-php"},"namespace App\\EventSubscriber\\Hasura;\n\nuse Symfony\\Component\\DependencyInjection\\ParameterBag\\ParameterBagInterface;\nuse Symfony\\Component\\EventDispatcher\\EventSubscriberInterface;\nuse Hasura\\EventDispatcher\\TableEvent;\nuse Symfony\\Component\\Mailer\\MailerInterface;\nuse Symfony\\Component\\Mime\\Email;\n\nfinal class WelcomeUserRegisteredSubscriber implements EventSubscriberInterface\n{\n    private string $appName;\n\n    private string $emailSender;\n\n    public function __construct(ParameterBagInterface $bag, private MailerInterface $mailer)\n    {\n        $this->appName = $bag->get('app.name');\n        $this->emailSender = $bag->get('app.email_sender');\n    }\n\n    public static function getSubscribedEvents()\n    {\n        return [\n            TableEvent::class => 'onTableEvent',\n        ];\n    }\n\n    public function onTableEvent(TableEvent $event)\n    {\n        if ('user_registered' !== $event->getTriggerName()) {\n            return;\n        }\n\n        # Discovery payload: https://hasura.io/docs/latest/graphql/core/event-triggers/payload.html#json-payload\n        $event = $event->getEvent();\n        $eventData = $event['data']['new'];\n\n        $welcomeEmail = new Email();\n        $welcomeEmail->from($this->emailSender);\n        $welcomeEmail->to($eventData['email']);\n        $welcomeEmail->subject($this->appName);\n        $welcomeEmail->html(sprintf('<h1>Hi %s, welcome to %s</h1>', $eventData['name'], $this->appName));\n\n        $this->mailer->send($welcomeEmail);\n    }\n}\n")),(0,i.kt)("p",null,"Nh\u01b0 v\xed d\u1ee5 tr\xean, v\u1edbi event trigger t\xean l\xe0 ",(0,i.kt)("inlineCode",{parentName:"p"},"user_registered")," \u0111\u01b0\u1ee3c t\u1ea1o \u1edf ",(0,i.kt)("a",{parentName:"p",href:"#add-event-trigger"},"b\u01b0\u1edbc \u0111\u1ea7u ti\xean"),", m\u1ed7i khi user registered (inserted) Hasura\ns\u1ebd trigger webhook \u0111\u1ebfn url path: ",(0,i.kt)("inlineCode",{parentName:"p"},"/hasura_table_event")," v\xe0 t\u1eeb \u0111\xf3 dispatcher s\u1ebd dispatch s\u1ef1 ki\u1ec7n ",(0,i.kt)("inlineCode",{parentName:"p"},"Hasura\\EventDispatcher\\TableEvent"),", subscriber\ns\u1ebd g\u1eedi mail welcome \u0111\u1ebfn end-user."),(0,i.kt)("h3",{id:"security-config"},"Security config"),(0,i.kt)("div",{className:"admonition admonition-info alert alert--info"},(0,i.kt)("div",{parentName:"div",className:"admonition-heading"},(0,i.kt)("h5",{parentName:"div"},(0,i.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,i.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"},(0,i.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M7 2.3c3.14 0 5.7 2.56 5.7 5.7s-2.56 5.7-5.7 5.7A5.71 5.71 0 0 1 1.3 8c0-3.14 2.56-5.7 5.7-5.7zM7 1C3.14 1 0 4.14 0 8s3.14 7 7 7 7-3.14 7-7-3.14-7-7-7zm1 3H6v5h2V4zm0 6H6v2h2v-2z"}))),"info")),(0,i.kt)("div",{parentName:"div",className:"admonition-content"},(0,i.kt)("p",{parentName:"div"},"N\u1ebfu nh\u01b0 project c\u1ee7a b\u1ea1n s\u1eed d\u1ee5ng ",(0,i.kt)("a",{parentName:"p",href:"/vi/installation/symfony-app"},"Symfony App"),", template \u0111\xe3 config s\u1eb5n gi\xfap b\u1ea1n, b\u1ea1n\nkh\xf4ng c\u1ea7n l\xe0m theo t\xe0i li\u1ec7u b\xean d\u01b0\u1edbi."))),(0,i.kt)("p",null,"Nh\u01b0 b\u1ea1n th\u1ea5y route path: ",(0,i.kt)("inlineCode",{parentName:"p"},"/hasura_table_event")," b\u1ea5t k\u1ef3 ai c\u0169ng c\xf3 th\u1ec3 send request \u0111\u1ebfn n\xf3, b\u1ea1n c\u1ea7n ph\u1ea3i c\u1ea5u h\xecnh security\ncho n\xf3 \u0111\u1ec3 cho ch\u1ec9 c\xf3 Hasura m\u1edbi c\xf3 th\u1ec3 request \u0111\u1ebfn route path n\xe0y, c\xf3 r\u1ea5t nhi\u1ec1u c\xe1ch \u0111\u1ec3 c\u1ea5u h\xecnh, trong t\xe0i li\u1ec7u n\xe0y ch\xfang ta\ns\u1ebd s\u1eed d\u1ee5ng basic authentication \u0111\u1ec3 x\xe1c minh request \u0111\u1ebfn t\u1eeb Hasura."),(0,i.kt)("p",null,"C\u1ea5u h\xecnh ",(0,i.kt)("a",{parentName:"p",href:"https://symfony.com/doc/current/security.html#http-basic"},"basic authentication"),"\nv\u1edbi ",(0,i.kt)("a",{parentName:"p",href:"https://symfony.com/doc/current/security/user_providers.html#security-memory-user-provider"},"memory user provider"),"\n\u0111\u1ec3 x\xe1c minh request \u0111\u1ebfn t\u1eeb Hasura:"),(0,i.kt)("pre",null,(0,i.kt)("code",{parentName:"pre",className:"language-yaml"},"security:\n    enable_authenticator_manager: true\n    password_hashers:\n        Symfony\\Component\\Security\\Core\\User\\InMemoryUser: 'plaintext'\n    providers:\n        ...\n        hasura:\n            memory:\n                users:\n                    hasura: { password: '%env(APP_HASURA_SECRET)%' }\n    firewalls:\n        ...\n        table_event:\n            pattern: ^/hasura_table_event$\n            stateless: true\n            provider: hasura\n            http_basic:\n                realm: Hasura Area\n    access_control:\n         ...\n         - { path: ^/hasura_table_event$, roles: IS_AUTHENTICATED_FULLY }\n\n")),(0,i.kt)("p",null,"Sau \u0111\xf3 khi b\u1ea1n ",(0,i.kt)("a",{parentName:"p",href:"#add-event-trigger"},"th\xeam event trigger t\u1ea1i Hasura"),", b\u1ea1n c\u1ea7n th\xeam basic auth header:"),(0,i.kt)("p",null,(0,i.kt)("img",{alt:"authorization header",src:t(510).Z})),(0,i.kt)("p",null,"L\u01b0u \xfd theo v\xed d\u1ee5 tr\xean b\u1ea1n c\u1ea7n config ",(0,i.kt)("inlineCode",{parentName:"p"},"APP_HASURA_SECRET")," trong ",(0,i.kt)("inlineCode",{parentName:"p"},".env")," c\u1ee7a application v\xe0 ",(0,i.kt)("inlineCode",{parentName:"p"},"APP_HASURA_BASIC_AUTH")," env c\u1ee7a ",(0,i.kt)("inlineCode",{parentName:"p"},"hasura")," service container.\nV\xed d\u1ee5 v\u1edbi ",(0,i.kt)("inlineCode",{parentName:"p"},"APP_HASURA_SECRET")," l\xe0 ",(0,i.kt)("inlineCode",{parentName:"p"},"!ChangeMe!")," th\xec ",(0,i.kt)("inlineCode",{parentName:"p"},"APP_HASURA_BASIC_AUTH")," s\u1ebd l\xe0 ",(0,i.kt)("inlineCode",{parentName:"p"},"Basic: aGFzdXJhOiFDaGFuZ2VNZSE=")," (base64_encode('hasura:!ChangeMe'))."))}h.isMDXComponent=!0},510:function(e,n,t){n.Z=t.p+"assets/images/config-webhook-authorization-header-03968ad2d130ce86753dd23012050ac4.png"}}]);