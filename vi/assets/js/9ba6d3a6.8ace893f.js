"use strict";(self.webpackChunkhasura_extra_github_io=self.webpackChunkhasura_extra_github_io||[]).push([[523],{9854:function(e,n,t){t.r(n),t.d(n,{frontMatter:function(){return l},contentTitle:function(){return p},metadata:function(){return o},toc:function(){return c},default:function(){return h}});var a=t(7462),i=t(3366),r=(t(7294),t(3905)),s=["components"],l={id:"laravel-table-event-handling",title:"Laravel table event handling",sidebar_label:"Laravel table event handling"},p=void 0,o={unversionedId:"events/laravel-table-event-handling",id:"events/laravel-table-event-handling",isDocsHomePage:!1,title:"Laravel table event handling",description:"Hasura Extra s\u1ebd dispatch event Hasura\\EventDispatcher\\TableEvent b\u1ea1n c\u1ea7n t\u1ea1o listener/subscriber \u0111\u1ec3 l\u1eafng nghe s\u1ef1 ki\u1ec7n n\xe0y.",source:"@site/i18n/vi/docusaurus-plugin-content-docs/current/04-events/02-laravel-table-event-handling.md",sourceDirName:"04-events",slug:"/events/laravel-table-event-handling",permalink:"/vi/events/laravel-table-event-handling",editUrl:"https://github.com/hasura-extra/hasura-extra/edit/main/docusaurus/i18n/vi/docusaurus-plugin-content-docs/current/04-events/02-laravel-table-event-handling.md",tags:[],version:"current",lastUpdatedBy:"Minh Vuong",lastUpdatedAt:1638641209,formattedLastUpdatedAt:"4/12/2021",sidebarPosition:2,frontMatter:{id:"laravel-table-event-handling",title:"Laravel table event handling",sidebar_label:"Laravel table event handling"},sidebar:"main",previous:{title:"Table event",permalink:"/vi/events/table-event"},next:{title:"Symfony table event handling",permalink:"/vi/events/symfony-table-event-handling"}},c=[{value:"Event handling",id:"event-handling",children:[],level:2},{value:"Security config",id:"security-config",children:[],level:2}],d={toc:c};function h(e){var n=e.components,l=(0,i.Z)(e,s);return(0,r.kt)("wrapper",(0,a.Z)({},d,l,{components:n,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"Hasura Extra s\u1ebd dispatch event ",(0,r.kt)("inlineCode",{parentName:"p"},"Hasura\\EventDispatcher\\TableEvent")," b\u1ea1n c\u1ea7n ",(0,r.kt)("a",{parentName:"p",href:"https://laravel.com/docs/8.x/events"},"t\u1ea1o listener/subscriber \u0111\u1ec3 l\u1eafng nghe s\u1ef1 ki\u1ec7n")," n\xe0y."),(0,r.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"C\xe1c v\xed d\u1ee5 b\xean d\u01b0\u1edbi \u0111\xe3 c\xf3 s\u1eb5n trong ",(0,r.kt)("a",{parentName:"p",href:"/vi/installation/application-templates"},"Laravel app")," b\u1ea1n c\xf3 th\u1ec3 khao kh\u1ea3o v\xe0 cho ch\u1ea1y th\u1eed."))),(0,r.kt)("h2",{id:"event-handling"},"Event handling"),(0,r.kt)("p",null,"Kh\u1edfi t\u1ea1o event listener th\xf4ng qua ",(0,r.kt)("a",{parentName:"p",href:"https://laravel.com/docs/8.x/events#generating-events-and-listeners"},"make")," command:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},'php artisan make:listener UserRegistered --event="\\Hasura\\EventDispatcher\\TableEvent"\n')),(0,r.kt)("p",null,"V\u1edbi ",(0,r.kt)("inlineCode",{parentName:"p"},"UserRegistered")," class nh\u01b0 sau:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="app/Listeners/UserRegistered.php"',title:'"app/Listeners/UserRegistered.php"'},"<?php\n\nnamespace App\\Listeners;\n\nuse App\\Mail\\WelcomeMail;\nuse Hasura\\EventDispatcher\\TableEvent;\nuse Illuminate\\Support\\Facades\\Mail;\n\nclass UserRegistered\n{\n    public function handle(TableEvent $event)\n    {\n        if ($event->getTriggerName() !== 'user_registered') {\n            return;\n        }\n\n        # Discovery payload: https://hasura.io/docs/latest/graphql/core/event-triggers/payload.html#json-payload\n        $event = $event->getEvent();\n        $eventData = $event['data']['new'];\n\n        Mail::to($eventData['email'])->send(new WelcomeMail($eventData['name']));\n    }\n}\n")),(0,r.kt)("p",null,"V\xe0 ",(0,r.kt)("inlineCode",{parentName:"p"},"App\\Mail\\WelcomeMail")," nh\u01b0 sau:"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="app/Mail/WelcomeMail.php"',title:'"app/Mail/WelcomeMail.php"'},"<?php\nnamespace App\\Mail;\n\nuse Illuminate\\Bus\\Queueable;\nuse Illuminate\\Mail\\Mailable;\nuse Illuminate\\Queue\\SerializesModels;\n\nclass WelcomeMail extends Mailable\n{\n    use Queueable, SerializesModels;\n\n    /**\n     * Create a new message instance.\n     *\n     * @return void\n     */\n    public function __construct(private string $name)\n    {\n    }\n\n    /**\n     * Build the message.\n     *\n     * @return $this\n     */\n    public function build()\n    {\n        return $this->html(\n            sprintf('<h1>Hi %s, welcome to %s</h1>', $this->name, config('app.name'))\n        );\n    }\n}\n")),(0,r.kt)("p",null,"Ti\u1ebfp \u0111\u1ebfn b\u1ea1n c\u1ea7n th\xeam s\u1ef1 ki\u1ec7n ",(0,r.kt)("inlineCode",{parentName:"p"},"Hasura\\EventDispatcher\\TableEvent")," trong ",(0,r.kt)("inlineCode",{parentName:"p"},"App\\Providers\\EventServiceProvider"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="app/Providers/EventServiceProvider.php"',title:'"app/Providers/EventServiceProvider.php"'},"use App\\Listeners\\UserRegistered;\nuse Hasura\\EventDispatcher\\TableEvent;\n\n/**\n * The event listener mappings for the application.\n *\n * @var array\n */\nprotected $listen = [\n    TableEvent::class => [\n        UserRegistered::class,\n    ],\n];\n")),(0,r.kt)("p",null,"Nh\u01b0 v\xed d\u1ee5 tr\xean v\u1edbi event trigger t\xean l\xe0 ",(0,r.kt)("inlineCode",{parentName:"p"},"user_registered"),", m\u1ed7i khi user registered (inserted) Hasura\ns\u1ebd trigger webhook \u0111\u1ebfn url path: ",(0,r.kt)("inlineCode",{parentName:"p"},"/hasura-table-event")," v\xe0 t\u1eeb \u0111\xf3 dispatcher s\u1ebd dispatch s\u1ef1 ki\u1ec7n ",(0,r.kt)("inlineCode",{parentName:"p"},"Hasura\\EventDispatcher\\TableEvent"),", listener\ns\u1ebd g\u1eedi mail welcome \u0111\u1ebfn end-user."),(0,r.kt)("div",{className:"admonition admonition-tip alert alert--success"},(0,r.kt)("div",{parentName:"div",className:"admonition-heading"},(0,r.kt)("h5",{parentName:"div"},(0,r.kt)("span",{parentName:"h5",className:"admonition-icon"},(0,r.kt)("svg",{parentName:"span",xmlns:"http://www.w3.org/2000/svg",width:"12",height:"16",viewBox:"0 0 12 16"},(0,r.kt)("path",{parentName:"svg",fillRule:"evenodd",d:"M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"}))),"tip")),(0,r.kt)("div",{parentName:"div",className:"admonition-content"},(0,r.kt)("p",{parentName:"div"},"N\u1ebfu nh\u01b0 b\u1ea1n ch\u01b0a bi\u1ebft c\xe1ch t\u1ea1o event trigger th\xec c\xf3 th\u1ec3 ",(0,r.kt)("a",{parentName:"p",href:"/vi/events/table-event#add-event-trigger"},"xem t\xe0i li\u1ec7u")))),(0,r.kt)("h2",{id:"security-config"},"Security config"),(0,r.kt)("p",null,"Nh\u01b0 b\u1ea1n th\u1ea5y route path: ",(0,r.kt)("inlineCode",{parentName:"p"},"/hasura-table-event")," b\u1ea5t k\u1ef3 ai c\u0169ng c\xf3 th\u1ec3 send request \u0111\u1ebfn n\xf3, b\u1ea1n c\u1ea7n ph\u1ea3i c\u1ea5u h\xecnh security\ncho n\xf3 \u0111\u1ec3 cho ch\u1ec9 c\xf3 Hasura m\u1edbi c\xf3 th\u1ec3 request \u0111\u1ebfn route path n\xe0y, c\xf3 r\u1ea5t nhi\u1ec1u c\xe1ch \u0111\u1ec3 c\u1ea5u h\xecnh, trong t\xe0i li\u1ec7u n\xe0y ch\xfang ta\ns\u1ebd s\u1eed d\u1ee5ng ",(0,r.kt)("a",{parentName:"p",href:"https://en.wikipedia.org/wiki/Basic_access_authentication"},"basic authentication")," \u0111\u1ec3 x\xe1c minh request \u0111\u1ebfn t\u1eeb Hasura."),(0,r.kt)("p",null,"Ch\xfang t\xf4i cung c\u1ea5p s\u1eb5n cho b\u1ea1n ",(0,r.kt)("inlineCode",{parentName:"p"},"hasura")," guard v\u1edbi username fixed l\xe0 ",(0,r.kt)("inlineCode",{parentName:"p"},"hasura")," v\xe0 password v\u1edbi gi\xe1 tr\u1ecb c\u1ee7a ",(0,r.kt)("inlineCode",{parentName:"p"},"app_secret")," (m\u1eb7c \u0111\u1ecbnh l\xe0 ",(0,r.kt)("inlineCode",{parentName:"p"},"APP_HASURA_SECRET")," env) trong file ",(0,r.kt)("inlineCode",{parentName:"p"},"config/hasura.php"),",\nb\u1ea1n ch\u1ec9 c\u1ea7n th\xeam ",(0,r.kt)("inlineCode",{parentName:"p"},"auth:hasura")," middleware cho ",(0,r.kt)("inlineCode",{parentName:"p"},"routes.table_event")," trong file ",(0,r.kt)("inlineCode",{parentName:"p"},"config/hasura.php"),":"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-php",metastring:'title="config/hasura.php"',title:'"config/hasura.php"'},"'table_event' => [\n    /*\n     * Enabled table event handle endpoint, disable it when you not use Hasura event triggered.\n     */\n    'enabled' => true,\n    /*\n     * Route uri.\n     */\n    'uri' => '/hasura-table-event',\n    /*\n     * Set of route middleware,\n     * `hasura` guard will be use basic auth with fixed user `hasura` and password's `app_secret` config value above.\n     */\n    'middleware' => ['auth:hasura']\n]\n")),(0,r.kt)("p",null,"Sau \u0111\xf3 khi b\u1ea1n ",(0,r.kt)("a",{parentName:"p",href:"/vi/events/table-event#add-event-trigger"},"th\xeam event trigger t\u1ea1i Hasura"),", b\u1ea1n c\u1ea7n th\xeam basic auth header:"),(0,r.kt)("p",null,(0,r.kt)("img",{alt:"authorization header",src:t(510).Z})),(0,r.kt)("p",null,"L\u01b0u \xfd theo v\xed d\u1ee5 tr\xean b\u1ea1n c\u1ea7n config ",(0,r.kt)("inlineCode",{parentName:"p"},"APP_HASURA_SECRET")," env c\u1ee7a application v\xe0 ",(0,r.kt)("inlineCode",{parentName:"p"},"APP_HASURA_BASIC_AUTH")," env c\u1ee7a ",(0,r.kt)("inlineCode",{parentName:"p"},"hasura")," service container.\nV\xed d\u1ee5 v\u1edbi ",(0,r.kt)("inlineCode",{parentName:"p"},"APP_HASURA_SECRET")," l\xe0 ",(0,r.kt)("inlineCode",{parentName:"p"},"!ChangeMe!")," th\xec ",(0,r.kt)("inlineCode",{parentName:"p"},"APP_HASURA_BASIC_AUTH")," s\u1ebd l\xe0 ",(0,r.kt)("inlineCode",{parentName:"p"},"Basic: aGFzdXJhOiFDaGFuZ2VNZSE=")," (base64_encode('hasura:!ChangeMe!'))."))}h.isMDXComponent=!0},510:function(e,n,t){n.Z=t.p+"assets/images/config-webhook-authorization-header-03968ad2d130ce86753dd23012050ac4.png"}}]);